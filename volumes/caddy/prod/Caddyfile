{
	dynamic_dns {
		provider cloudflare {$CLOUDFLARE_API_TOKEN}
		domains {
			{$BASE_DOMAIN} @ www lampa
		}
	}
}

(otp_auth) {
	forward_auth {args[0]} http://backend {
		uri /api/otp/verify
		copy_headers Cookie
		header_down Set-Cookie
		header_up Remote-Addr {host}
		header_up Original-URI {uri}
	}
}

{$BASE_DOMAIN} {
    @cors_preflight {
        method OPTIONS
        header Origin *.{$BASE_DOMAIN}
    }
    respond @cors_preflight 204
    header @cors_preflight {
        Access-Control-Allow-Origin {http.request.header.Origin}
        Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE"
        Access-Control-Allow-Headers "{http.request.header.Access-Control-Request-Headers}"
        Access-Control-Allow-Credentials "true"
        Vary "Origin"
    }

    @cors {
        header Origin *.{$BASE_DOMAIN}
    }
    header @cors {
        Access-Control-Allow-Origin {http.request.header.Origin}
        Access-Control-Allow-Credentials "true"
        Vary "Origin"
    }

	@api path /api /api/* /_ /_/*
	handle @api {
		reverse_proxy http://backend
	}

	handle {
		reverse_proxy http://frontend
	}
}

lampa.{$BASE_DOMAIN} {
	@only_index {
		path /
		path /lampa-main/index.html
	}

	import otp_auth @only_index

	handle /lampa-main/plugins/modification.js {
		root * /lampa-plugins
		rewrite * /modification.js
		file_server
	}

	handle {
		reverse_proxy http://lampa
	}
}
